!function(){var x,w;function y(t,e){var n,i={}.hasOwnProperty;for(n in e)i.call(e,n)&&(t[n]=e[n]);return t}function b(t,e){for(var n=-1,i=e.length>>>0;++n<i;)if(t===e[n])return!0;return!1}x=function(e,t,n){return e.node.addEventListener(t,function(t){return n(y({evt:t},e))})},(w=function(t){var e,n,i,r,o,s,a,l,d,h,c=this;for(null==t&&(t={}),this.evtHandler={},this.ctxs=t.ctxs||null,this.views=[this].concat(t.baseViews||[]),this.ctx=t.context||t.ctx||null,t.context&&console.warn("[ldview] `context` is deprecated. use `ctx` instead."),this.attr=t.attr||{},this.style=t.style||{},this.handler=t.handler||{},this.action=t.action||{},this.text=t.text||{},this.initer=t.init||{},this.prefix=t.prefix,this.global=t.global||!1,this.ld=this.global?"pd":"ld",this.initRender=null==t.initRender||t.initRender,this.root="string"==typeof t.root?ld$.find(document,t.root,0):t.root,this.root||console.warn("[ldview] warning: no node found for root ",t.root),this.root.setAttribute&&!this.global&&(this.id="ld-"+Math.random().toString(36).substring(2),this.root.setAttribute("ld-scope-"+this.id,"")),(this.template=t.template)&&(this.root.textContent="",this.root.appendChild(this.template.cloneNode(!0))),this.update(),e={},n=0,s=(i=[function(){var t=[];for(r in this.initer)t.push(r);return t}.call(this)].concat([function(){var t=[];for(r in this.attr)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.style)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.text)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.handler)t.push(r);return t}.call(this)],function(){var t,e=[];for(r in t=this.action)o=t[r],e.push(o);return e}.call(this).map(function(t){var e,n=[];for(e in t)n.push(e);return n}))).length;n<s;++n)for(l=0,d=(a=i[n]).length;l<d;++l)e[a[l]]=!0;for(r in h=[],e)h.push(r);return this.names=h,this.initRender&&this.init().then(function(){return c.render()}),this}).prototype=y(Object.create(Object.prototype),{update:function(t){var e,n,i,r,o,s,a=this;if(null==t&&(t=this.root),this.nodes||(this.nodes=[]),this.eaches||(this.eaches=[]),this.map||(this.map={nodes:{},eaches:{}}),e=this.prefix?"["+this.ld+"-each^="+this.prefix+"\\$]":"["+this.ld+"-each]",n=this.global?[]:ld$.find(t,(this.id?"[ld-scope-"+this.id+"] ":"")+"[ld-scope] "+e),o=ld$.find(t,e),i=this.eaches.map(function(t){return t.n}),r=o.filter(function(t){return!b(t,n)}).filter(function(t){return!b(t,i)}).map(function(t){var e,n,i,r;if(!t.parentNode)return null;try{if(ld$.parent(t.parentNode,"*["+a.ld+"-each]"))return null}catch(t){0}return r=t.getAttribute(a.ld+"-each"),a.handler[r]?(e=t.parentNode,n={idx:Array.from(e.childNodes).indexOf(t),node:t,name:r,nodes:[]},i=document.createComment(" "+a.ld+"-each="+r+" "),a.handler[r].host||e.insertBefore(i,t),e.removeChild(t),(i._data=n).proxy=i,n.container=(r=a.handler[r].host)?new r({root:e}):e,n):null}).filter(function(t){return t}),this.eaches=this.eaches.concat(r),r.map(function(t){var e,n;return((e=a.map.eaches)[n=t.name]||(e[n]=[])).push(t)}),e=this.prefix?"["+this.ld+"^="+this.prefix+"\\$]":"["+this.ld+"]",n=this.global?[]:ld$.find(t,(this.id?"[ld-scope-"+this.id+"] ":"")+"[ld-scope] "+e),o=(o=ld$.find(t,e)).filter(function(t){return!(b(t,n)||b(t,a.nodes))}),this.nodes=this.nodes.concat(o),s=this.prefix?new RegExp("^"+this.prefix+"\\$"):null,o.map(function(n){var i=(n.getAttribute(a.ld)||"").split(" ");return(i=a.prefix?i.map(function(t){return t.replace(s,"").trim()}):i).map(function(t){var e;return((e=a.map.nodes)[t]||(e[t]=[])).push({node:n,names:i,local:{},evts:{}})})}),!this.map.nodes["@"])return this.map.nodes["@"]=[{node:this.root,names:"@",local:{},evts:{}}]},procEach:function(n,i,e,r){var o,s,a,l,t,d,h,c,u,f,p,m,v,x,w=this;for(null==e&&(e=null),o=this.handler[n].list({name:i.name,node:i.node,views:this.views,context:this.ctx,ctx:this.ctx,ctxs:this.ctxs})||[],s=this.handler[n].key,a={},l=[],s?o.map(function(t){return a[s(t)]=t}):s=function(t){return t},t=i.nodes.filter(function(t){return t}).map(function(t){var e=s(t._data);return"object"!=typeof e&&!a[e]||"object"==typeof e&&!b(t._data,o)?(i.container.removeChild(t),t._data=null):l.push(e),t}).filter(function(t){return t._data}),(d=Array.from(i.container.childNodes).indexOf(i.proxy))<0&&(d=i.container.childNodes.length),h=[],c=o.length-1;0<=c;--c)f=o[u=c],0<=(p=l.indexOf(s(f)))?((m=t[p])._data=f,m._obj||(m._obj={node:m,name:n,idx:u,local:{}}),m._obj.data=f,Array.from(i.container.childNodes).indexOf(m)!==(v=d-(o.length-u))&&(i.container.removeChild(m),v=(d=(d=Array.from(i.container.childNodes).indexOf(i.proxy))<0?i.container.childNodes.length:d)-(o.length-u),i.container.insertBefore(m,i.container.childNodes[v+1]),d+=1)):((m=i.node.cloneNode(!0))._data=f,m._obj={node:m,name:n,data:f,idx:u,local:{}},m.removeAttribute(this.ld+"-each"),v=d-(o.length-u),i.container.insertBefore(m,i.container.childNodes[v+1]),d+=1),h.splice(0,0,m);return x=h.filter(function(t){return t}),x=(x=null!=e?x.filter(function(t){return b(s(t._obj.data),e)}):x).map(function(t,e){return w._render(n,t._obj,e,w.handler[n],!0,r)}),i.container.update&&i.container.update(),i.nodes=h,Promise.all(x)},get:function(t){return((this.map.nodes[t]||[])[0]||{}).node},getAll:function(t){return(this.map.nodes[t]||[]).map(function(t){return t.node})},_render:function(e,t,n,s,i,r){var o,a,l,d,h,c,u,f,p,m,v=[];t.ctx=this.ctx,t.context=this.ctx,t.ctxs=this.ctxs,t.views=this.views,s?s.view?(o=function(t){var e=t.node,n=t.local,i=t.data,r=t.ctx,o=t.ctxs,t=t.views;return n._view=new w(((i=y({ctx:i},s.view)).initRender=!1,i.root=e,i.baseViews=t,i.ctxs=o?[r].concat(o):[r],i)),n._view.init()},a=function(t){var e=t.local,t=t.data;return i&&e._view.setCtx(t),e._view.render()}):(o=s.init||null,a=s.handler||s.handle||null,l=s.text||null,d=s.attr||null,h=s.style||null,c=s.action||{}):(o=(u=[this.initer[e],this.handler[e],this.attr[e],this.style[e],this.text[e],this.action])[0],a=u[1],d=u[2],h=u[3],l=u[4],c=u[5]);try{if(o&&!(t.inited||(t.inited={}))[e]&&(t.inited[e]=Promise.resolve(o(t)).then(function(){return t.inited[e]=!0})),r)return Promise.resolve((t.inited||(t.inited={}))[e]);if(a&&a(t),l&&(t.node.textContent="function"==typeof l?l(t):l),d)for(f in u=d(t)||{})p=u[f],t.node.setAttribute(f,p);if(h)for(f in u=h(t)||{})p=u[f],t.node.style[f]=p;for(f in u=c||{})(p=u[f])&&(m=s?p:p[e])&&!(t.evts||(t.evts={}))[f]&&(x(t,f,m),v.push(t.evts[f]=!0));return v}catch(t){throw i=t,console.warn("[ldview] failed when rendering "+e+":",i),i}},bindEachNode:function(t){var e=t.name,n=t.container,i=t.idx,t=t.node;if(e=this.map.eaches[e].filter(function(t){return t.container===n})[0])return null!=i?e.nodes.splice(i,0,t):e.nodes.push(t)},unbindEachNode:function(t){var e=t.name,n=t.container,i=t.idx,t=t.node;if(e=this.map.eaches[e].filter(function(t){return t.container===n})[0])return t&&!i&&(i=e.nodes.indexOf(t)),e.nodes.splice(i,1)},init:function(t){for(var e,n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);return e=n,this._prerender("init",t,e)},render:function(t){for(var e,n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);return e=n,this._prerender("render",t,e)},_prerender:function(t,e,n){var r,o,s=this,a="init"===t;return this.fire("beforeRender"),r=function(n){var t,e,i=[];return"object"==typeof n&&(t=[n.name,n.key],n=t[0],e=t[1],Array.isArray(e)||(e=[e])),s.map.nodes[n]&&(i=i.concat(s.map.nodes[n].map(function(t,e){return t.name=n,t.idx=e,s._render(n,t,e,"object"==typeof s.handler[n]?{view:s.handler[n]}:null,!1,a)}))),s.map.eaches[n]&&s.handler[n]&&(i=i.concat(s.map.eaches[n].map(function(t){return s.procEach(n,t,e,a)}))),Promise.all(i)},n=e?(Array.isArray(e)?e:[e]).concat(n).map(r):function(){for(var t,e=[],n=0,i=(t=this.names).length;n<i;++n)o=t[n],e.push(r(o));return e}.call(this),this.fire("afterRender"),Promise.all(n)},setContext:function(t){return console.warn("[ldview] `setContext` is deprecated. use `setCtx` instead."),this.ctx=t},setCtx:function(t){return this.ctx=t},on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){for(var e,n,i,r,o=[],s=[],a=1,l=arguments.length;a<l;++a)s.push(arguments[a]);for(e=s,a=0,i=(n=this.evtHandler[t]||[]).length;a<i;++a)r=n[a],o.push(r.apply(this,e));return o}}),"undefined"!=typeof module&&null!==module&&(module.exports=w),"undefined"!=typeof window&&null!==window&&(window.ldView=window.ldview=w)}.call(this);
